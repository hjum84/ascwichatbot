<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
    
    <!-- Custom Favicon for Chatbot Admin -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='grad1' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%2322c55e;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%2334d399;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='6' fill='url(%23grad1)'/%3E%3C!-- Robot Head --%3E%3Crect x='8' y='6' width='16' height='12' rx='2' fill='white'/%3E%3C!-- Eyes --%3E%3Ccircle cx='12' cy='11' r='1.5' fill='%2316a34a'/%3E%3Ccircle cx='20' cy='11' r='1.5' fill='%2316a34a'/%3E%3C!-- Mouth --%3E%3Crect x='13' y='14' width='6' height='1' rx='0.5' fill='%2316a34a'/%3E%3C!-- Gear Icon (Admin) --%3E%3Cg transform='translate(20,20) scale(0.8)'%3E%3Cpath d='M6 2L6 0L10 0L10 2L12 2.5L13.5 1L15.5 3L14 4.5L14.5 6L16 6L16 10L14.5 10L14 11.5L15.5 13L13.5 15L12 13.5L10 14L10 16L6 16L6 14L4 13.5L2.5 15L0.5 13L2 11.5L1.5 10L0 10L0 6L1.5 6L2 4.5L0.5 3L2.5 1L4 2.5L6 2Z M8 6A2 2 0 0 0 8 10A2 2 0 0 0 8 6Z' fill='white'/%3E%3C/g%3E%3C/svg%3E">
    <link rel="shortcut icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='grad1' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%2322c55e;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%2334d399;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='6' fill='url(%23grad1)'/%3E%3C!-- Robot Head --%3E%3Crect x='8' y='6' width='16' height='12' rx='2' fill='white'/%3E%3C!-- Eyes --%3E%3Ccircle cx='12' cy='11' r='1.5' fill='%2316a34a'/%3E%3Ccircle cx='20' cy='11' r='1.5' fill='%2316a34a'/%3E%3C!-- Mouth --%3E%3Crect x='13' y='14' width='6' height='1' rx='0.5' fill='%2316a34a'/%3E%3C!-- Gear Icon (Admin) --%3E%3Cg transform='translate(20,20) scale(0.8)'%3E%3Cpath d='M6 2L6 0L10 0L10 2L12 2.5L13.5 1L15.5 3L14 4.5L14.5 6L16 6L16 10L14.5 10L14 11.5L15.5 13L13.5 15L12 13.5L10 14L10 16L6 16L6 14L4 13.5L2.5 15L0.5 13L2 11.5L1.5 10L0 10L0 6L1.5 6L2 4.5L0.5 3L2.5 1L4 2.5L6 2Z M8 6A2 2 0 0 0 8 10A2 2 0 0 0 8 6Z' fill='white'/%3E%3C/g%3E%3C/svg%3E">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container-admin">
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-12"> <!-- Adjusted column for potentially wider layout -->
                <div class="admin-main-card"> <!-- Changed class -->
                    <div class="admin-main-header">
                        <div class="admin-header-left">
                        <img src="{{ url_for('static', filename='images/logo-banner.png') }}" alt="ACS OTWD Logo" class="logo-banner">
                            <div class="header-title-container">
                                <p class="header-subtitle">Intelligent Assistant</p>
                        <h2>Chatbot Admin Dashboard</h2>
                            </div>
                        </div>
                        <div class="admin-header-right">
                            <div class="admin-header-version">v2.4.0</div>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if message %}
                        <div class="alert alert-{{ message_type }}" role="alert">
                            {{ message }}
                        </div>
                        {% endif %}
                        
                        <!-- Main Navigation Tabs -->
                        <ul class="nav nav-pills mb-4" id="adminTabs" role="tablist"> <!-- Removed nav-fill -->
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage-content" type="button" role="tab" aria-controls="manage-content" aria-selected="true">
                                    <i class="bi bi-list-check"></i> Manage Existing Chatbots
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-content" type="button" role="tab" aria-controls="create-content" aria-selected="false">
                                    <i class="bi bi-plus-circle"></i> Create New Chatbot
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="trash-tab" data-bs-toggle="tab" data-bs-target="#trash-content" type="button" role="tab" aria-controls="trash-content" aria-selected="false">
                                    <i class="bi bi-trash"></i> Deleted Chatbots
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-content" type="button" role="tab" aria-controls="stats-content" aria-selected="false">
                                    <i class="bi bi-database"></i> Database Statistics
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="data-mgmt-tab" data-bs-toggle="tab" data-bs-target="#data-mgmt-content" type="button" role="tab" aria-controls="data-mgmt-content" aria-selected="false">
                                    <i class="bi bi-table"></i> Data Management
                                </button>
                            </li>
                        </ul>
                        
                        <!-- Tab Content -->
                        <div class="tab-content" id="adminTabsContent">
                            <!-- DATABASE STATISTICS TAB -->
                            <div class="tab-pane fade" id="stats-content" role="tabpanel" aria-labelledby="stats-tab">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h2 class="section-title"><i class="bi bi-database"></i> Database Statistics</h2>
                                    </div>
                                    <div class="card-body">
                                        {% if alerts %}
                                        <div class="alert alert-warning">
                                            <h5><i class="bi bi-exclamation-triangle"></i> Database Alerts</h5>
                                            <ul class="mb-0">
                                                {% for alert in alerts %}
                                                <li>{{ alert.message }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                        
                                        {% if db_stats.percent_used > 80 %}
                                        <div class="alert alert-danger">
                                            <h5><i class="bi bi-exclamation-circle-fill"></i> Storage Capacity Warning</h5>
                                            <p>Your database is currently at <strong>{{ db_stats.percent_used }}%</strong> of its maximum capacity ({{ db_stats.max_size_pretty }}).</p>
                                            <p><strong>Recommended actions:</strong></p>
                                            <ul>
                                                <li>Consider upgrading your Render database plan to increase storage capacity</li>
                                                <li>Archive or delete old chat histories</li>
                                                <li>Optimize chatbot content size</li>
                                            </ul>
                                        </div>
                                        {% endif %}
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h5>Storage Usage</h5>
                                                <p><strong>Total Database Size:</strong> {{ db_stats.total_size }} <span class="text-muted">(of {{ db_stats.max_size_pretty }} allowed)</span></p>
                                                <p><strong>Chat History Size:</strong> {{ db_stats.chat_history_size }}</p>
                                                <p><strong>Chatbot Contents Size:</strong> {{ db_stats.chatbot_contents_size }}</p>
                                                
                                                <h6><i class="bi bi-bar-chart-fill"></i> Overall Database Usage (% of Maximum Capacity)</h6>
                                                <p class="small text-muted">Shows how much of your total database capacity is currently being used</p>
                                                <div class="progress mb-3">
                                                    <div class="progress-bar {{ 'bg-danger' if db_stats.percent_used > 80 else 'bg-success' }}" role="progressbar"
                                                         data-width="{{ db_stats.percent_used }}"
                                                         aria-valuemin="0"
                                                         aria-valuemax="100">
                                                        {{ db_stats.percent_used }}% of {{ db_stats.max_size_pretty }} Used
                                                    </div>
                                                </div>
                                                <h6><i class="bi bi-pie-chart-fill"></i> Storage Breakdown by Data Type (% of Maximum Capacity)</h6>
                                                <p class="small text-muted">Shows how storage is distributed between chat history and other data</p>
                                                <div class="progress mb-3">
                                                    <div class="progress-bar bg-primary" role="progressbar"
                                                         data-width="{{ (db_stats.chat_history_size_bytes / db_stats.max_size_bytes * 100) | round(1) }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        Chat History ({{ (db_stats.chat_history_size_bytes / db_stats.max_size_bytes * 100) | round(1) }}%)
                                                    </div>
                                                    <div class="progress-bar bg-info" role="progressbar"
                                                         data-width="{{ ((db_stats.total_size_bytes - db_stats.chat_history_size_bytes) / db_stats.max_size_bytes * 100) | round(1) }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        Other Data ({{ ((db_stats.total_size_bytes - db_stats.chat_history_size_bytes) / db_stats.max_size_bytes * 100) | round(1) }}%)
                                                    </div>
                                                </div>
                                                <p class="small text-muted">
                                                    <i class="bi bi-info-circle"></i> Maximum database size is set to {{ db_stats.max_size_pretty }}. 
                                                    <span class="{{ 'text-danger' if db_stats.percent_used > 80 else '' }}">
                                                        Currently using {{ db_stats.percent_used }}% of available storage.
                                                    </span>
                                                </p>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <h5>Usage Statistics</h5>
                                                <p><strong>Total Messages:</strong> {{ db_stats.total_messages }}</p>
                                                <p><strong>Total Chatbots:</strong> {{ db_stats.total_chatbots }}</p>
                                                <p><strong>Unique Users:</strong> {{ db_stats.unique_users }}</p>
                                                <p><strong>Last Updated:</strong> {{ db_stats.timestamp | to_eastern }}</p>
                                            </div>
                                        </div>
                                        <div class="mt-4">
                                            <h5><i class="bi bi-info-circle"></i> About Database Limits</h5>
                                            <p>Your database is hosted on Render with a maximum capacity of {{ db_stats.max_size_pretty }}. Storage usage is monitored automatically, and alerts will be displayed when approaching capacity limits.</p>
                                            
                                            <h6>To increase database capacity:</h6>
                                            <ol>
                                                <li>Log in to your Render dashboard</li>
                                                <li>Navigate to the database settings</li>
                                                <li>Upgrade your database plan or increase storage capacity</li>
                                            </ol>
                                            <div class="alert alert-info">
                                                <i class="bi bi-lightbulb"></i> <strong>Tip:</strong> Regular monitoring of database usage helps prevent unexpected service interruptions due to storage limits.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- MANAGE EXISTING CHATBOTS TAB -->
                            <div class="tab-pane fade show active" id="manage-content" role="tabpanel" aria-labelledby="manage-tab">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h2 class="section-title"><i class="bi bi-list-check"></i> Manage Existing Chatbots</h2>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-info">
                                            <strong>Note:</strong> Here you can manage all your active chatbots. You can edit content, update descriptions, set quotas, or delete chatbots.
                                        </div>
                                        
                                        <!-- Search and Stats Bar -->
                                        <div class="chatbot-search-container">
                                            <div class="chatbot-search-box">
                                                <input type="text" class="form-control" id="chatbotSearchInput" placeholder="Search chatbots by name, ID, or category...">
                                                <i class="bi bi-search search-icon"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="chatbot-stats-bar">
                                            <div class="chatbot-count">
                                                <i class="bi bi-robot"></i> Total Chatbots: <span id="totalChatbotCount">{{ available_chatbots|length if available_chatbots else 0 }}</span>
                                            </div>
                                            <div class="chatbot-view-toggle">
                                                <button type="button" class="btn btn-sm btn-outline-secondary active" id="gridViewBtn">
                                                    <i class="bi bi-grid-3x3-gap"></i> Grid
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" id="listViewBtn">
                                                    <i class="bi bi-list"></i> List
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="chatbot-list">
                                            {% if available_chatbots %}
                                                {% for chatbot in available_chatbots %}
                                                <div class="card chatbot-card" data-chatbot-name="{{ chatbot.display_name|lower }}" data-chatbot-id="{{ chatbot.code|lower }}" data-chatbot-category="{{ chatbot.category|lower if chatbot.category else 'standard' }}">
                                                    <div class="card-header chatbot-card-header">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <h5 class="mb-0">{{ chatbot.display_name }}</h5>
                                                            <div class="chatbot-id-badge">{{ chatbot.code }}</div>
                                                        </div>
                                                    </div>
                                                    <div class="card-body chatbot-card-body">
                                                        <!-- Quick Info Summary -->
                                                        <div class="chatbot-quick-info">
                                                            <div class="chatbot-quota-info">
                                                                <i class="bi bi-clock-history"></i>
                                                                <span>{{ chatbot.quota | default(3) }} questions/day</span>
                                                            </div>
                                                            <div class="chatbot-category-badge {{ chatbot.category if chatbot.category else 'standard' }}">
                                                                {{ chatbot.category if chatbot.category else 'standard' }}
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Action Buttons -->
                                                        <div class="chatbot-actions-row">
                                                            <button type="button" class="btn btn-info edit-content-btn"
                                                                    data-chatbot-code="{{ chatbot.code }}" data-chatbot-display-name="{{ chatbot.display_name }}">
                                                                <i class="bi bi-pencil-square"></i> Edit Content
                                                            </button>
                                                            <button type="button" class="btn btn-danger delete-btn" 
                                                                    data-chatbot-name="{{ chatbot.code }}">
                                                                <i class="bi bi-trash"></i> Delete
                                                            </button>
                                                        </div>
                                                        
                                                        <!-- Toggle for Details -->
                                                        <button class="chatbot-details-toggle collapsed" type="button" data-bs-toggle="collapse" 
                                                                data-bs-target="#details-{{ chatbot.code }}" aria-expanded="false">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span><i class="bi bi-gear"></i> Advanced Settings</span>
                                                                <i class="bi bi-chevron-down toggle-icon"></i>
                                                            </div>
                                                        </button>
                                                        
                                                        <!-- Collapsible Details Content -->
                                                        <div class="collapse chatbot-details-content" id="details-{{ chatbot.code }}">
                                                            <!-- Description Section -->
                                                            <div class="chatbot-form-section">
                                                                <h6><i class="bi bi-card-text"></i> Description</h6>
                                                                <p class="text-muted small mb-2">{{ chatbot.description or 'No description available' }}</p>
                                                                <div class="update-desc-form">
                                                                    <input type="hidden" class="chatbot-name" value="{{ chatbot.code }}">
                                                                    <div class="mb-2">
                                                                        <textarea class="form-control description-field" rows="2" placeholder="Update description...">{{ chatbot.description }}</textarea>
                                                                    </div>
                                                                    <button type="button" class="btn btn-primary update-desc-btn">
                                                                        <i class="bi bi-check-circle"></i> Update Description
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Daily Quota Section -->
                                                            <div class="chatbot-form-section">
                                                                <h6><i class="bi bi-speedometer2"></i> Daily Quota</h6>
                                                                <div class="update-quota-form">
                                                                    <input type="hidden" class="chatbot-name" value="{{ chatbot.code }}">
                                                                    <div class="input-group">
                                                                        <input type="number" class="form-control quota-field" value="{{ chatbot.quota | default(3) }}" min="1">
                                                                        <button type="button" class="btn btn-secondary update-quota-btn">
                                                                            <i class="bi bi-arrow-clockwise"></i> Update
                                                                        </button>
                                                                    </div>
                                                                    <div class="form-text small mt-2">
                                                                        <i class="bi bi-info-circle"></i> Maximum questions a user can ask per day
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Category Section -->
                                                            <div class="chatbot-form-section">
                                                                <h6><i class="bi bi-tags"></i> Category</h6>
                                                                <div class="update-category-form">
                                                                    <input type="hidden" class="chatbot-name" value="{{ chatbot.code }}">
                                                                    <div class="input-group">
                                                                        <select class="form-select category-field">
                                                                            <option value="standard" {% if chatbot is defined and (chatbot.category == 'standard' or not chatbot.category) %}selected{% endif %}>Standard Programs</option>
                                                                            <option value="tap" {% if chatbot is defined and chatbot.category == 'tap' %}selected{% endif %}>TAP Programs</option>
                                                                            <option value="jsa" {% if chatbot is defined and chatbot.category == 'jsa' %}selected{% endif %}>JSA Programs</option>
                                                                            <option value="ild" {% if chatbot is defined and chatbot.category == 'ild' %}selected{% endif %}>ILD Programs</option>
                                                                            <option value="elearning" {% if chatbot is defined and chatbot.category == 'elearning' %}selected{% endif %}>eLearning</option>
                                                                        </select>
                                                                        <button type="button" class="btn btn-secondary update-category-btn">
                                                                            <i class="bi bi-arrow-clockwise"></i> Update
                                                                        </button>
                                                                    </div>
                                                                    <div class="form-text small mt-2">
                                                                        <i class="bi bi-info-circle"></i> Category determines how the program is grouped on the selection page
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="chatbot-form-section">
                                                                <h6><i class="bi bi-shield-lock"></i> Access Control</h6>
                                                                <div class="update-lo-root-form">
                                                                    <input type="hidden" class="chatbot-name" value="{{ chatbot.code }}">
                                                                    <div class="mb-2">
                                                                        <textarea class="form-control lo-root-field" rows="4" placeholder="Enter LO Root IDs separated by semicolons">{{ chatbot.lo_root_ids | join(';') if chatbot.lo_root_ids else '' }}</textarea>
                                                                        <div class="form-text small">
                                                                            <i class="bi bi-info-circle"></i> Only users with matching LO Root IDs can access this chatbot<br>
                                                                            <strong>Format:</strong> Enter multiple IDs separated by semicolons (;)<br>
                                                                            <strong>Example:</strong> <code>5f09de4c-51f4-4296-a9aa-55ccb46a7f59;9412df89-80fb-4432-81ce-b521572aba71</code><br>
                                                                            <small class="text-muted">Leave empty to allow access for all users</small>
                                                                        </div>
                                                                    </div>
                                                                    <button type="button" class="btn btn-warning update-lo-root-btn">
                                                                        <i class="bi bi-shield-check"></i> Update Access Control
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Intro Message Section -->
                                                            <div class="chatbot-form-section">
                                                                <h6><i class="bi bi-chat-left-quote"></i> Intro Message</h6>
                                                                <div class="update-intro-form">
                                                                    <input type="hidden" class="chatbot-name" value="{{ chatbot.code }}">
                                                                    <div class="card mb-2 bg-light">
                                                                        <div class="card-body py-2">
                                                                            <div class="intro-message-preview">
                                                                                <strong>Preview:</strong> <span class="preview-text">
                                                                                    {% if 'intro_message' in chatbot %}
                                                                                        {{ chatbot.intro_message.replace('{program}', chatbot.display_name).replace('{quota}', chatbot.quota | string) }}
                                                                                    {% else %}
                                                                                        Hi, I am the {{ chatbot.display_name }} chatbot. I can answer up to {{ chatbot.quota }} question(s) related to this program per day.
                                                                                    {% endif %}
                                                                                </span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <textarea class="form-control intro-field" rows="2">{% if 'intro_message' in chatbot %}{{ chatbot.intro_message }}{% else %}Hi, I am the {program} chatbot. I can answer up to {quota} question(s) related to this program per day.{% endif %}</textarea>
                                                                        <div class="form-text small">
                                                                            <i class="bi bi-info-circle"></i> Use <code>{program}</code> and <code>{quota}</code> placeholders
                                                                            <button type="button" class="btn btn-sm btn-link text-decoration-none reset-intro-btn p-0 ms-2">Reset to default</button>
                                                                        </div>
                                                                    </div>
                                                                    <button type="button" class="btn btn-primary update-intro-btn">
                                                                        <i class="bi bi-check-circle"></i> Update Intro Message
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="alert alert-info chatbot-no-results">
                                                    <i class="bi bi-info-circle"></i> No chatbots are currently registered. Click on the "Create New Chatbot" tab to create your first chatbot.
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Create New Chatbot Tab -->
                            <div class="tab-pane fade" id="create-content" role="tabpanel" aria-labelledby="create-tab">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h2 class="section-title"><i class="bi bi-plus-circle"></i> Create New Chatbot</h2>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-info">
                                            <strong>Note:</strong> You can upload multiple files at once. Supported file types: <strong>.txt, .pdf, .ppt, .pptx, .docx</strong>.<br>
                                            The text will be extracted from each file and combined for the chatbot content.
                                        </div>
                                        
                                        <!-- Use an AJAX form submission with manual handling -->
                                        <form id="upload-form" enctype="multipart/form-data">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="course_name" class="form-label">Chatbot ID</label>
                                                        <input type="text" class="form-control" id="course_name" name="course_name" required>
                                                        <div class="form-text">Enter a short identifier (e.g.: BCC, MI, Safety)</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="display_name" class="form-label">Display Name</label>
                                                        <input type="text" class="form-control" id="display_name" name="display_name">
                                                        <div class="form-text">Full name to display (e.g.: Building Coaching Competency)</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="description" class="form-label">Program Description</label>
                                                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                                                <div class="form-text">Brief description of the program (will appear on selection page)</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="category" class="form-label">Program Category</label>
                                                <select class="form-select" id="category" name="category">
                                                    <option value="standard" {% if chatbot is defined and (chatbot.category == 'standard' or not chatbot.category) %}selected{% endif %}>Standard Programs</option>
                                                    <option value="tap" {% if chatbot is defined and chatbot.category == 'tap' %}selected{% endif %}>TAP Programs</option>
                                                    <option value="jsa" {% if chatbot is defined and chatbot.category == 'jsa' %}selected{% endif %}>JSA Programs</option>
                                                    <option value="ild" {% if chatbot is defined and chatbot.category == 'ild' %}selected{% endif %}>ILD Programs</option>
                                                    <option value="elearning" {% if chatbot is defined and chatbot.category == 'elearning' %}selected{% endif %}>eLearning</option>
                                                </select>
                                                <div class="form-text">Category determines how the program is grouped on the selection page</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="intro_message" class="form-label">Chatbot Intro Message</label>
                                                <textarea class="form-control" id="intro_message" name="intro_message" rows="2">Hi, I am the {program} chatbot. I can answer up to {quota} question(s) related to this program per day.</textarea>
                                                <div class="form-text">
                                                    <i class="bi bi-info-circle"></i> 
                                                    Welcome message shown to users. Use <code>{program}</code> to insert program name and <code>{quota}</code> to insert daily quota.
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="default_quota" class="form-label">Default Daily Question Quota</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="default_quota" name="default_quota" min="1" max="20" value="3">
                                                    <span class="input-group-text">questions per day</span>
                                                </div>
                                                <div class="form-text">Maximum number of questions a user can ask per day. Default is 3.</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="lo_root_ids" class="form-label">
                                                    <i class="bi bi-shield-lock"></i> LO Root IDs (Access Control)
                                                </label>
                                                <textarea class="form-control" id="lo_root_ids" name="lo_root_ids" rows="3" placeholder="Enter LO Root IDs separated by semicolons (optional)"></textarea>
                                                <div class="form-text">
                                                    <strong>Access Control:</strong> Only users with matching LO Root IDs can access this chatbot.<br>
                                                    <strong>Format:</strong> Enter multiple IDs separated by semicolons (;)<br>
                                                    <strong>Example:</strong> <code>5f09de4c-51f4-4296-a9aa-55ccb46a7f59;9412df89-80fb-4432-81ce-b521572aba71</code><br>
                                                    <small class="text-muted">Leave empty to allow access for all users</small>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="char_limit" class="form-label">Character Limit</label>
                                                <input type="number" class="form-control" id="char_limit" name="char_limit" min="50000" max="200000" value="50000">
                                                <div class="form-text">Maximum number of characters allowed in the chatbot's content (50,000 - 200,000). This limit applies to the total combined text extracted from all uploaded files. Higher limits will increase API costs as the entire content is sent with each conversation.</div>
                                            </div>
                                            
                                            <div class="mb-3 form-check">
                                                <input type="checkbox" class="form-check-input" id="auto_summarize" name="auto_summarize" checked>
                                                <label class="form-check-label" for="auto_summarize">Automatically summarize content if it exceeds the character limit</label>
                                                <div class="form-text">When enabled, content will be intelligently trimmed to fit within the character limit by removing duplicates, boilerplate text, and formatting.</div>
                                                <div class="alert alert-warning mt-2 small">
                                                    <p><strong><i class="bi bi-exclamation-triangle"></i> Important Notice:</strong></p>
                                                    <ul class="mb-0">
                                                        <li>The auto-summarization feature analyzes text content to remove duplicate content, formatting elements, and unnecessary instructions.</li>
                                                        <li>For better summarization quality, copy and paste only essential content directly from PowerPoint or Word documents.</li>
                                                        <li>PowerPoint presenter notes are not extracted, so important content should be included in the slide body.</li>
                                                        <li>For best results, it is recommended to organize and upload the content manually.</li>
                                                    </ul>
                                                </div>
                                            </div>
                                            
                                            <!-- 개선된 파일 업로드 영역 -->
                                            <div class="mb-4">
                                                <label class="form-label">Upload Files</label>
                                                <div class="file-upload-area" id="dropArea">
                                                    <div class="drag-message">
                                                        <i class="bi bi-cloud-arrow-up-fill d-block"></i>
                                                        <p>Drag and drop files here, or click below to select files</p>
                                                        <input type="file" class="form-control" id="file" name="file" accept=".txt,.pdf,.ppt,.pptx,.docx" multiple style="display: none;">
                                                        <button type="button" id="browseFilesBtn" class="btn btn-outline-primary mt-2">
                                                            <i class="bi bi-folder2-open"></i> Browse Files
                                                        </button>
                                                    </div>
                                                    
                                                    <div class="file-list mt-3" id="fileList" style="display: none;">
                                                        <!-- 파일 목록이 여기에 표시됩니다 -->
                                                    </div>
                                                    
                                                    <div class="d-flex justify-content-between mt-2" id="fileActions" style="display: none !important;">
                                                        <button type="button" class="btn btn-sm btn-outline-danger" id="clearAllFilesBtn">
                                                            <i class="bi bi-trash"></i> Clear All
                                                        </button>
                                                        <div class="file-counter" id="fileCounter"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">System Prompt</label>
                                                <div class="row g-2">
                                                    <div class="col-12">
                                                        <label for="system_prompt_guidelines" class="form-label">Important Guidelines</label>
                                                        <textarea class="form-control" id="system_prompt_guidelines" name="system_prompt_guidelines" rows="7" required>1. Only answer questions based on the provided content
2. If the answer is not in the content, say "I don't have enough information to answer that question"
3. Be concise but thorough in your responses
4. Maintain a professional and helpful tone
5. If asked about something not covered in the content, do not make assumptions
6. Preserve all important facts, key concepts, and essential information
7. Present information in a clear and organized manner
8. Use examples from the content when relevant
9. If multiple interpretations are possible, explain the different perspectives
10. Always cite specific parts of the content when providing detailed answers</textarea>
                                                        <div class="form-text">Specify the guidelines that the chatbot should follow when responding to user questions. These guidelines will directly affect how the chatbot processes and responds to queries.</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex justify-content-start mt-3">
                                                <button type="button" id="preview-btn" class="btn btn-secondary me-2"><i class="bi bi-eye"></i> Preview Content</button>
                                                <button type="button" id="submit-btn" class="btn btn-primary" disabled><i class="bi bi-plus-circle"></i> Create Chatbot</button>
                                            </div>
                                        </form>
                                        
                                        <!-- Preview section will be dynamically shown here -->
                                        <div id="preview-section" class="mt-4" style="display: none;">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h4 class="mb-0">Content Preview</h4>
                                                <button type="button" id="cancel-preview-btn" class="btn btn-outline-secondary">
                                                    <i class="bi bi-arrow-left"></i> Back to Upload
                                                </button>
                                            </div>
                                            <div class="alert alert-info mb-3">
                                                <p>Review the extracted content below. You can edit the content before uploading if needed.</p>
                                                <p><strong>Instructions:</strong></p>
                                                <ol>
                                                    <li>Review the extracted text from each file</li>
                                                    <li>Make any necessary edits directly in the text boxes</li>
                                                    <li>Click "Apply Changes" to update the content</li>
                                                    <li>When satisfied, click "Create Chatbot" to save</li>
                                                </ol>
                                            </div>
                                            
                                            <div id="character-count-info" class="mb-3">
                                                <div class="card">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <h5 class="card-title mb-0">Content Statistics</h5>
                                                            <div id="total-char-counter" class="char-counter">
                                                                <span id="total-char-count">0</span> / <span id="char-limit">50,000</span> characters
                                                            </div>
                                                        </div>
                                                        <div class="progress mt-2">
                                                            <div class="progress-bar" role="progressbar" id="char-progress-bar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                                        </div>
                                                        <div id="limit-warning" class="alert alert-danger mt-3" style="display: none;">
                                                            <p><strong>Warning: Content exceeds the character limit!</strong></p>
                                                            <p id="limit-warning-message"></p>
                                                            <div class="d-flex justify-content-between align-items-center mt-2">
                                                                <div>
                                                                    <button id="summarize-now-btn" class="btn btn-warning btn-sm">
                                                                        <span class="summarize-btn-text"><i class="bi bi-magic"></i> Summarize Now</span>
                                                                        <span class="spinner-border spinner-border-sm summarize-spinner" role="status" style="display: none;"></span>
                                                                    </button>
                                                                </div>
                                                                <div>
                                                                    <button id="increase-limit-btn" class="btn btn-outline-secondary btn-sm">Increase Limit</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <ul class="nav nav-tabs mb-3" id="contentTabs" role="tablist">
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link active" id="files-tab" data-bs-toggle="tab" data-bs-target="#files-content" type="button" role="tab" aria-controls="files-content" aria-selected="true">Individual Files</button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="combined-tab" data-bs-toggle="tab" data-bs-target="#combined-content" type="button" role="tab" aria-controls="combined-content" aria-selected="false">Combined Content</button>
                                                </li>
                                            </ul>
                                            
                                            <div class="tab-content" id="contentTabsContent">
                                                <div class="tab-pane fade show active" id="files-content" role="tabpanel" aria-labelledby="files-tab">
                                                    <div id="file-previews" class="mb-4">
                                                        <!-- Individual file previews will be added here -->
                                                    </div>
                                                </div>
                                                <div class="tab-pane fade" id="combined-content" role="tabpanel" aria-labelledby="combined-tab">
                                                    <div class="mb-4">
                                                        <div class="card">
                                                            <div class="card-body">
                                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                                    <label for="combined-preview" class="form-label mb-0">Full Content (Editable)</label>
                                                                    <div class="char-counter">
                                                                        <span id="combined-char-count">0</span> characters
                                                                    </div>
                                                                </div>
                                                                <textarea id="combined-preview" class="form-control file-content-editor" style="min-height: 400px;"></textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex justify-content-between mt-3">
                                                <button type="button" id="cancel-preview-btn-bottom" class="btn btn-outline-secondary">
                                                    <i class="bi bi-arrow-left"></i> Back to Upload
                                                </button>
                                                <div class="d-flex">
                                                    <button type="button" id="update-combined-content" class="btn btn-primary me-2"><i class="bi bi-check2-all"></i> Apply Changes & Create</button>
                                                    <span id="update-combined-content-status" class="text-success align-self-center" style="display: none;">Changes applied successfully!</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- DELETED CHATBOTS TAB -->
                            <div class="tab-pane fade" id="trash-content" role="tabpanel" aria-labelledby="trash-tab">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h2 class="section-title"><i class="bi bi-trash"></i> Deleted Chatbots</h2>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-warning">
                                            <strong>Note:</strong> Chatbots in this section can be restored or permanently deleted.
                                        </div>
                                        
                                        <div class="deleted-chatbots">
                                            {% if deleted_chatbots %}
                                                {% for chatbot in deleted_chatbots %}
                                                <div class="card chatbot-card">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <h5 class="card-title mb-0">{{ chatbot.display_name }}</h5>
                                                            <div>
                                                                <button type="button" class="btn btn-success btn-sm restore-btn me-2"
                                                                        data-chatbot-name="{{ chatbot.code }}"><i class="bi bi-arrow-counterclockwise"></i> Restore</button>
                                                                <button type="button" class="btn btn-danger btn-sm permanent-delete-btn"
                                                                        data-chatbot-name="{{ chatbot.code }}"><i class="bi bi-trash"></i> Permanent Delete</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="alert alert-info">No deleted chatbots found.</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- DATA MANAGEMENT TAB -->
                            <div class="tab-pane fade" id="data-mgmt-content" role="tabpanel" aria-labelledby="data-mgmt-tab">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h2 class="section-title"><i class="bi bi-table"></i> Data Management</h2>
                                    </div>
                                    <div class="card-body">
                                        <!-- Subtabs -->
                                        <ul class="nav nav-tabs mb-3" id="dataMgmtTabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="users-mgmt-tab" data-bs-toggle="tab" data-bs-target="#users-mgmt" type="button" role="tab">User Management</button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="convo-logs-tab" data-bs-toggle="tab" data-bs-target="#convo-logs" type="button" role="tab">Conversation Logs</button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="download-tab" data-bs-toggle="tab" data-bs-target="#download-data" type="button" role="tab">Download</button>
                                            </li>
                                        </ul>
                                        <div class="tab-content" id="dataMgmtTabsContent">
                                            <!-- User Management -->
                                            <div class="tab-pane fade show active" id="users-mgmt" role="tabpanel">
                                                <!-- Authorized Users CSV Management Section -->
                                                <div class="card mb-4">
                                                    <div class="card-header">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <h6 class="mb-0">
                                                                <i class="bi bi-file-earmark-spreadsheet"></i> Registration Authorization Management
                                                            </h6>
                                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#csvManagement" aria-expanded="false">
                                                                <i class="bi bi-chevron-down"></i> Manage CSV
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="collapse" id="csvManagement">
                                                        <div class="card-body">
                                                            <div class="alert alert-info">
                                                                <i class="bi bi-info-circle"></i> 
                                                                <strong>CSV-based Registration Control:</strong> Only users listed in the authorized CSV file with 'active' status can register. 
                                                                Upload a new CSV to update registration permissions.
                                                            </div>
                                                            
                                                            <!-- CSV Status Display -->
                                                            <div class="row mb-3">
                                                                <div class="col-md-6">
                                                                    <div class="card border-0 bg-light">
                                                                        <div class="card-body py-2">
                                                                            <h6 class="card-title mb-1">CSV File Status</h6>
                                                                            <div id="csvStatus">
                                                                                <span class="text-muted">Loading status...</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <div class="card border-0 bg-light">
                                                                        <div class="card-body py-2">
                                                                            <h6 class="card-title mb-1">Required CSV Format</h6>
                                                                            <small class="text-muted">
                                                                                Columns: <code>last_name, email, status, lo_root_id</code><br>
                                                                                Status: <code>active</code> or <code>inactive</code>
                                                                            </small>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- CSV Management Actions -->
                                                            <div class="row">
                                                                <div class="col-md-6">
                                                                    <h6>Upload New Authorized Users CSV</h6>
                                                                    <form action="{{ url_for('admin_upload_authorized_users_csv') }}" method="post" enctype="multipart/form-data" id="csvUploadForm">
                                                                        <div class="input-group mb-3">
                                                                            <input type="file" class="form-control" name="file" accept=".csv" required id="csvFileInput">
                                                                            <button type="submit" class="btn btn-primary">
                                                                                <i class="bi bi-upload"></i> Upload CSV
                                                                            </button>
                                                                        </div>
                                                                        <div class="form-text">
                                                                            <i class="bi bi-exclamation-triangle"></i> 
                                                                            This will replace the current CSV file and affect registration permissions immediately.
                                                                        </div>
                                                                    </form>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <h6>Download Current CSV</h6>
                                                                    <div class="d-grid">
                                                                        <a href="{{ url_for('admin_download_authorized_users_csv') }}" class="btn btn-outline-secondary mb-2" id="downloadCsvBtn">
                                                                            <i class="bi bi-download"></i> Download Current CSV
                                                                        </a>
                                                                        <button type="button" class="btn btn-info btn-sm" onclick="refreshCsvStatus()">
                                                                            <i class="bi bi-arrow-clockwise"></i> Refresh Status
                                                                        </button>
                                                                    </div>
                                                                    <div class="form-text">
                                                                        Download the current file for editing or backup purposes.
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="d-flex justify-content-between mb-2">
                                                    <h5>User List</h5>
                                                    <div>
                                                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">Add User</button>
                                                        <button type="button" class="btn btn-info btn-sm ms-2" id="editSelectedUsers" disabled>Edit Selected</button>
                                                        <button type="button" class="btn btn-danger btn-sm ms-2" id="deleteSelectedUsers" disabled>Delete Selected</button>
                                                    </div>
                                                </div>
                                                <div class="table-responsive">
                                                    <table class="table table-striped">
                                                        <!-- User Management Table Header with Filters -->
                                                        <thead>
                                                            <tr>
                                                            <th>
                                                                <input type="checkbox" class="form-check-input" id="selectAllUsers">
                                                            </th>
                                                            <th>
                                                                ID
                                                                <input type="text" class="form-control form-control-sm mt-1 column-filter" data-column="id" placeholder="Filter ID...">
                                                            </th>
                                                            <th>
                                                                Last Name
                                                                <input type="text" class="form-control form-control-sm mt-1 column-filter" data-column="last_name" placeholder="Filter Last Name...">
                                                            </th>
                                                            <th>
                                                                Email
                                                                <input type="text" class="form-control form-control-sm mt-1 column-filter" data-column="email" placeholder="Filter Email...">
                                                            </th>
                                                            <th>
                                                                Visit Count
                                                                <input type="number" class="form-control form-control-sm mt-1 column-filter" data-column="visit_count" placeholder="Filter Count...">
                                                            </th>
                                                            <th>
                                                                Status
                                                                <select class="form-select form-select-sm mt-1 column-filter" data-column="status">
                                                                    <option value="">All</option>
                                                                    <option value="active">Active</option>
                                                                    <option value="inactive">Inactive</option>
                                                                </select>
                                                            </th>
                                                            <th>
                                                                Date Added
                                                                <input type="date" class="form-control form-control-sm mt-1 column-filter" data-column="date_added">
                                                            </th>
                                                            <th>
                                                                Expiry Date
                                                                <input type="date" class="form-control form-control-sm mt-1 column-filter" data-column="expiry_date">
                                                            </th>
                                                            <th>
                                                                LO Root IDs
                                                                <select class="form-select form-select-sm mt-1 column-filter" data-column="lo_root_ids">
                                                                    <option value="">All</option>
                                                                    {% set all_lo_ids = [] %}
                                                                    {% for user in users %}
                                                                        {% for loid in user.lo_root_ids %}
                                                                            {% if loid not in all_lo_ids %}{% set _ = all_lo_ids.append(loid) %}{% endif %}
                                                                        {% endfor %}
                                                                    {% endfor %}
                                                                    {% for loid in all_lo_ids %}
                                                                        <option value="{{ loid }}">{{ loid }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="userTableBody">
                                                            {% for user in users %}
                                                            <tr>
                                                                <td>
                                                                    <input type="checkbox" class="form-check-input user-select" value="{{ user.id }}">
                                                                </td>
                                                                <td>{{ user.id }}</td>
                                                                <td>{{ user.last_name }}</td>
                                                                <td>{{ user.email }}</td>
                                                                <td>{{ user.visit_count }}</td>
                                                                <td>{{ user.status }}</td>
                                                                <td>{{ user.date_added | to_eastern }}</td>
                                                                <td>{{ user.expiry_date | to_eastern }}</td>
                                                                <td>{{ user.lo_root_ids|join(', ') }}</td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <!-- Add User Modal -->
                                            <div class="modal fade" id="addUserModal" tabindex="-1">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title">Add New User</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form id="addUserForm">
                                                                <div class="mb-3">
                                                                    <label for="lastName" class="form-label">Last Name</label>
                                                                    <input type="text" class="form-control" id="lastName" required>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="email" class="form-label">Email</label>
                                                                    <input type="email" class="form-control" id="email" required>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="loRootIds" class="form-label">LO Root IDs (semicolon-separated)</label>
                                                                    <input type="text" class="form-control" id="loRootIds" placeholder="e.g. ID1;ID2;ID3">
                                                                    <div class="form-text">Separate multiple IDs with semicolons (;)</div>
                                                                </div>
                                                            </form>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                            <button type="button" class="btn btn-primary" id="submitAddUser">Add User</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Delete Users Modal -->
                                            <div class="modal fade" id="deleteUsersModal" tabindex="-1">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title">Delete Selected Users</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            Are you sure you want to delete the selected users? This action cannot be undone.
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                            <button type="button" class="btn btn-danger" id="confirmDeleteUsers">Delete</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Conversation Logs -->
                                            <div class="tab-pane fade" id="convo-logs" role="tabpanel">
                                                <div class="d-flex justify-content-between mb-2 align-items-center">
                                                    <h5>Conversation Logs (Paired)</h5>
                                                    <div class="filter-controls">
                                                        <input type="text" class="form-control" id="searchConvoInput" placeholder="Search messages..." value="{{ search_term if search_term else '' }}">
                                                        <select class="form-select" id="chatbotConvoFilter">
                                                            <option value="">All Chatbots</option>
                                                            {% for chatbot in available_chatbots %}
                                                            <option value="{{ chatbot.code }}" {% if chatbot.code == selected_chatbot_code %}selected{% endif %}>{{ chatbot.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                        <select class="form-select" id="userConvoFilter">
                                                            <option value="">All Users</option>
                                                            {% for user in users %}
                                                            <option value="{{ user.id }}" {% if user.id|string == selected_user_id %}selected{% endif %}>{{ user.last_name }} ({{ user.email }})</option>
                                                            {% endfor %}
                                                        </select>
                                                        <button class="btn btn-primary" onclick="applyConvoFilters()">Filter</button>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <div class="d-flex gap-2 justify-content-end">
                                                        <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAllModal">
                                                            <i class="bi bi-trash"></i> Delete All Conversations
                                                        </button>
                                                        <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteByChatbotModal">
                                                            <i class="bi bi-trash"></i> Delete by Chatbot
                                                        </button>
                                                        <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteByUserModal">
                                                            <i class="bi bi-trash"></i> Delete by User
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="table-responsive">
                                                    <table class="table table-bordered table-hover">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>User</th>
                                                                <th>Chatbot</th>
                                                                <th>User Message</th>
                                                                <th>Bot Response</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="convoLogsTable">
                                                            {% if conversations %}
                                                                {% for conv_pair in conversations %}
                                                                <tr>
                                                                    <td>
                                                                        {{ conv_pair.user_name }} ({{ conv_pair.user_email }})
                                                                        <br><small class="text-muted">{{ conv_pair.user_timestamp | to_eastern }}</small>
                                                                    </td>
                                                                    <td>{{ conv_pair.chatbot_name }}</td>
                                                                    <td style="word-wrap: break-word; min-width: 250px; max-width: 350px;">
                                                                        {{ conv_pair.user_message }}
                                                                    </td>
                                                                    <td style="word-wrap: break-word; min-width: 250px; max-width: 350px;">
                                                                        {{ conv_pair.bot_message }}
                                                                        {% if conv_pair.bot_timestamp != 'N/A' %}
                                                                        <br><small class="text-muted">{{ conv_pair.bot_timestamp | to_eastern }}</small>
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% endfor %}
                                                            {% else %}
                                                                <tr><td colspan="4" class="text-center">No conversation logs found or matching current filters.</td></tr>
                                                            {% endif %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <!-- Add pagination controls -->
                                                {% if pagination %}
                                                <nav aria-label="Conversation pages" class="mt-3">
                                                    <ul class="pagination justify-content-center">
                                                        {% for pg in range(1, pagination.total_pages + 1) %}
                                                        <li class="page-item {% if pg == pagination.current_page %}active{% endif %}">
                                                            <a class="page-link" href="{{ url_for('admin', page=pg, per_page=pagination.per_page, search_term=search_term, chatbot_code=selected_chatbot_code, user_id=selected_user_id) }}#data-mgmt-content-convo-logs">{{ pg }}</a>
                                                        </li>
                                                        {% endfor %}
                                                    </ul>
                                                </nav>
                                                {% endif %}
                                            </div>
                                            <!-- Download -->
                                            <div class="tab-pane fade" id="download-data" role="tabpanel">
                                                <h5>Download Data</h5>
                                                <p>Export user data or conversation logs in CSV or Excel format.</p>
                                                <div class="mb-3">
                                                    <h6>Users</h6>
                                                    <button class="btn btn-outline-primary me-2" onclick="window.location.href='/admin/export_data?type=users&format=csv'">Users (CSV)</button>
                                                    <button class="btn btn-outline-success" onclick="window.location.href='/admin/export_data?type=users&format=excel'">Users (Excel)</button>
                                                </div>
                                                <div class="mb-3">
                                                    <h6>Conversations (Raw Log)</h6>
                                                    <button class="btn btn-outline-primary me-2" onclick="window.location.href='/admin/export_data?type=conversations&format=csv'">Conversations (CSV)</button>
                                                    <button class="btn btn-outline-success" onclick="window.location.href='/admin/export_data?type=conversations&format=excel'">Conversations (Excel)</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <a href="{{ url_for('home') }}" class="btn btn-secondary">Return to Home</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Delete ALL Conversations Modal -->
        <div class="modal fade" id="deleteAllModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Delete All Conversations</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill"></i> Warning: This action cannot be undone!
                        </div>
                        <p>Are you sure you want to permanently delete <strong>ALL conversations</strong> from the database?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <form action="/admin/delete_conversations" method="post">
                            <input type="hidden" name="delete_type" value="all">
                            <button type="submit" class="btn btn-danger">Delete All Conversations</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Delete by Chatbot Modal -->
        <div class="modal fade" id="deleteByChatbotModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Delete Conversations by Chatbot</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill"></i> Warning: This action cannot be undone!
                        </div>
                        <p>Select a chatbot to delete all of its conversation history:</p>
                        <form id="deleteByChatbotForm" action="/admin/delete_conversations" method="post">
                            <input type="hidden" name="delete_type" value="by_chatbot">
                            <div class="mb-3">
                                <select class="form-select" name="chatbot_code" required>
                                    <option value="" disabled selected>Select a chatbot</option>
                                    {% for chatbot in available_chatbots %}
                                    <option value="{{ chatbot.code }}">{{ chatbot.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" form="deleteByChatbotForm" class="btn btn-danger">Delete Selected Chatbot Conversations</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Delete by User Modal -->
        <div class="modal fade" id="deleteByUserModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Delete Conversations by User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill"></i> Warning: This action cannot be undone!
                        </div>
                        <p>Select a user to delete all of their conversation history:</p>
                        <form id="deleteByUserForm" action="/admin/delete_conversations" method="post">
                            <input type="hidden" name="delete_type" value="by_user">
                            <div class="mb-3">
                                <select class="form-select" name="user_id" required>
                                    <option value="" disabled selected>Select a user</option>
                                    {% for user in users %}
                                    <option value="{{ user.id }}">{{ user.last_name }} ({{ user.email }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" form="deleteByUserForm" class="btn btn-danger">Delete Selected User Conversations</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for Editing Content -->
    <div class="modal fade" id="editContentModal" tabindex="-1" aria-labelledby="editContentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editContentModalLabel">Edit Chatbot Content</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editChatbotNameInput">
                    
                    <div class="mb-3">
                        <label for="editCharLimit" class="form-label">Character Limit</label>
                        <input type="number" class="form-control" id="editCharLimit" name="char_limit" min="50000" max="200000" value="50000">
                        <div class="form-text">Maximum number of characters allowed in the chatbot\'s content (50,000 - 200,000). This limit applies to the total combined text extracted from all uploaded files. Higher limits will increase API costs as the entire content is sent with each conversation.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editSystemPromptGuidelines" class="form-label">System Prompt Guidelines</label>
                        <textarea class="form-control" id="editSystemPromptGuidelines" name="system_prompt_guidelines" rows="5" placeholder="Enter guidelines for the chatbot's behavior..."></textarea>
                        <div class="form-text">Specify detailed guidelines and rules for how the chatbot should process and respond to queries.</div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editAutoSummarize" name="auto_summarize" checked>
                        <label class="form-check-label" for="editAutoSummarize">Automatically summarize content if it exceeds the character limit</label>
                        <div class="form-text">When enabled, content will be intelligently trimmed to fit within the character limit by removing duplicates, boilerplate text, and formatting.</div>
                        <div class="alert alert-warning mt-2 small">
                            <p><strong><i class="bi bi-exclamation-triangle"></i> Important Notice:</strong></p>
                            <ul class="mb-0">
                                <li>The auto-summarization feature analyzes text content to remove duplicate content, formatting elements, and unnecessary instructions.</li>
                                <li>For better summarization quality, copy and paste only essential content directly from PowerPoint or Word documents.</li>
                                <li>PowerPoint presenter notes are not extracted, so important content should be included in the slide body.</li>
                                <li>For best results, it is recommended to organize and upload the content manually.</li>
                            </ul>
                        </div>
                    </div>
                    
                    <ul class="nav nav-tabs mb-3" id="editContentTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="current-content-tab" data-bs-toggle="tab" data-bs-target="#current-content-panel" type="button" role="tab" aria-controls="current-content-panel" aria-selected="true">Current Content</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="upload-files-tab" data-bs-toggle="tab" data-bs-target="#upload-files-panel" type="button" role="tab" aria-controls="upload-files-panel" aria-selected="false">Upload New Files</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="editContentTabsContent">
                        <div class="tab-pane fade show active" id="current-content-panel" role="tabpanel" aria-labelledby="current-content-tab">
                            <div class="mb-3">
                                <label for="chatbotContentTextarea" class="form-label">Current Content</label>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Character count: <span id="currentCharCount">0</span></span>
                                    <span class="text-muted">Character limit: <span id="charLimitDisplay">50,000</span></span>
                                </div>
                                <textarea id="chatbotContentTextarea" class="form-control" rows="20" style="white-space: pre-wrap; word-wrap: break-word;"></textarea>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="upload-files-panel" role="tabpanel" aria-labelledby="upload-files-tab">
                            <div class="mb-3">
                                <label for="editFiles" class="form-label">Upload New Files</label>
                                <div class="file-upload-area" id="editDropArea">
                                    <div class="drag-message">
                                        <i class="bi bi-cloud-arrow-up-fill d-block"></i>
                                        <p>Drag and drop files here, or click below to select files</p>
                                        <input type="file" class="form-control" id="editFiles" name="files" accept=".txt,.pdf,.ppt,.pptx,.docx" multiple style="display: none;">
                                        <button type="button" id="editBrowseFilesBtn" class="btn btn-outline-primary mt-2">
                                            <i class="bi bi-folder2-open"></i> Browse Files
                                        </button>
                                    </div>
                                    
                                    <div class="file-list mt-3" id="editFileList" style="display: none;">
                                        <!-- 파일 목록이 여기에 표시됩니다 -->
                                    </div>
                                    
                                    <div class="d-flex justify-content-between mt-2" id="editFileActions" style="display: none !important;">
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="editClearAllFilesBtn">
                                            <i class="bi bi-trash"></i> Clear All
                                        </button>
                                        <div class="file-counter" id="editFileCounter"></div>
                                    </div>
                                </div>
                                <div class="form-text">Upload new files to replace or add to the current content. Supported: .txt, .pdf, .ppt, .pptx, .docx</div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="appendContent" checked>
                                    <label class="form-check-label" for="appendContent">
                                        Append new files to existing content (uncheck to replace all content)
                                    </label>
                                </div>
                                <button type="button" id="editPreviewBtn" class="btn btn-primary mt-3"><i class="bi bi-eye"></i> Preview Files</button>
                            </div>
                            
                            <div id="edit-preview-section" class="mt-4" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">File Preview</h5>
                                    <button type="button" id="edit-cancel-preview-btn" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-left"></i> Back to Upload
                                    </button>
                                </div>
                                <div class="alert alert-info">
                                    <p>Review and edit the extracted content before saving changes.</p>
                                    <ol>
                                        <li>Review the extracted text from each file</li>
                                        <li>Make any necessary edits</li>
                                        <li>Click "Apply Changes" to update</li>
                                    </ol>
                                </div>
                                
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">Content Statistics</h6>
                                            <div id="edit-total-char-counter" class="char-counter">
                                                <span id="edit-total-char-count">0</span> / <span id="edit-char-limit">50000</span> characters
                                            </div>
                                        </div>
                                        <div class="progress mt-2">
                                            <div class="progress-bar" role="progressbar" id="edit-char-progress-bar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                        </div>
                                        <div id="edit-limit-warning" class="alert alert-danger mt-3" style="display: none;">
                                            <p><strong>Warning: Content exceeds the character limit!</strong></p>
                                            <p id="edit-limit-warning-message"></p>
                                            <div class="d-flex justify-content-between align-items-center mt-2">
                                                <button id="edit-summarize-now-btn" class="btn btn-warning btn-sm">
                                                    <span class="summarize-btn-text"><i class="bi bi-magic"></i> Summarize Now</span>
                                                    <span class="spinner-border spinner-border-sm summarize-spinner" role="status" style="display: none;"></span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <ul class="nav nav-tabs mb-3" id="editPreviewTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="edit-files-tab" data-bs-toggle="tab" data-bs-target="#edit-files-content" type="button" role="tab" aria-controls="edit-files-content" aria-selected="true">Individual Files</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="edit-combined-tab" data-bs-toggle="tab" data-bs-target="#edit-combined-content" type="button" role="tab" aria-controls="edit-combined-content" aria-selected="false">Combined Content</button>
                                    </li>
                                </ul>
                                
                                <div class="tab-content" id="editPreviewTabsContent">
                                    <div class="tab-pane fade show active" id="edit-files-content" role="tabpanel" aria-labelledby="edit-files-tab">
                                        <div id="edit-file-previews" class="mb-3">
                                            <!-- Individual file previews will be added here -->
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="edit-combined-content" role="tabpanel" aria-labelledby="edit-combined-tab">
                                        <div class="mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                        <label for="edit-combined-preview" class="form-label mb-0">Combined Content (Editable)</label>
                                                        <div class="char-counter">
                                                            <span id="edit-combined-char-count">0</span> characters
                                                        </div>
                                                    </div>
                                                    <textarea id="edit-combined-preview" class="form-control file-content-editor" style="min-height: 400px;"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between mt-3 mb-3">
                                    <button type="button" id="edit-cancel-preview-btn-bottom" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-left"></i> Back to Upload
                                    </button>
                                    <div class="d-flex">
                                        <button type="button" id="update-edit-combined-content" class="btn btn-primary"><i class="bi bi-check2-all"></i> Apply Changes & Save</button>
                                        <span id="update-edit-combined-content-status" class="ms-2 text-success align-self-center" style="display: none;">Changes applied!</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-circle"></i> Close</button>
                    <button type="button" class="btn btn-primary" id="saveContentChangesBtn"><i class="bi bi-save"></i> Save Changes</button>
                </div>
            </div>
        </div>
        <!-- Warning Modal for Edit -->
        <div class="modal fade" id="editWarningModal" tabindex="-1" aria-labelledby="editWarningModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editWarningModalLabel">Content Length Warning</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <p id="edit-warning-message"></p>
                            <p>Total content length: <strong id="edit-warning-content-length"></strong> characters</p>
                            <p>Character limit: <strong id="edit-warning-char-limit"></strong> characters</p>
                        </div>
                        <p>Would you like to:</p>
                        <ul>
                            <li>Reduce the content size by removing unnecessary text</li>
                            <li>Increase the character limit (this will increase API costs as the entire content is sent with each conversation)</li>
                            <li>Cancel the changes</li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning" id="edit-increase-limit-btn">Increase Limit</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Edit User Modal - Moved outside other modals to fix display issues -->
        <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editUserForm">
                            <input type="hidden" id="editUserId">
                            <div class="mb-3">
                                <label for="editLastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="editLastName" required>
                            </div>
                            <div class="mb-3">
                                <label for="editEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editEmail" required>
                            </div>
                            <div class="mb-3">
                                <label for="editStatus" class="form-label">Status</label>
                                <select class="form-select" id="editStatus">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editExpiryDate" class="form-label">Expiry Date</label>
                                <input type="date" class="form-control" id="editExpiryDate">
                            </div>
                            <div class="mb-3">
                                <label for="editLoRootIds" class="form-label">LO Root IDs (semicolon-separated)</label>
                                <input type="text" class="form-control" id="editLoRootIds" placeholder="e.g. ID1;ID2;ID3">
                                <div class="form-text">Separate multiple IDs with semicolons (;)</div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="submitEditUser">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
        
        <!-- Global variables for Flask URLs -->
        <script>
            // Global URL variables for external JavaScript
            window.adminUrls = {
                upload: "{{ url_for('admin_upload') }}",
                previewUpload: "{{ url_for('admin_preview_upload') }}",
                deleteChatbot: "{{ url_for('admin_delete_chatbot') }}",
                updateDescription: "{{ url_for('admin_update_description') }}",
                restoreChatbot: "{{ url_for('admin_restore_chatbot') }}",
                permanentDeleteChatbot: "{{ url_for('admin_permanent_delete_chatbot') }}",
                getChatbotContent: "/admin/get_chatbot_content/",
                updateChatbotContent: "/admin/update_chatbot_content",
                updateQuota: "/update_quota",
                updateIntroMessage: "/update_intro_message",
                updateCategory: "{{ url_for('admin_update_category') }}",
                deleteSelectedUsers: "/admin/delete_selected_users",
                addUser: "/admin/add_user",
                getUsers: "/admin/get_users",
                editUser: "/admin/edit_user",
                adminBase: "{{ url_for('admin') }}",
                csvUpload: "{{ url_for('admin_upload_authorized_users_csv') }}",
                csvDownload: "{{ url_for('admin_download_authorized_users_csv') }}",
                csvStatus: "{{ url_for('admin_authorized_users_status') }}"
            };
            
            // CSV Management Functions
            function refreshCsvStatus() {
                const statusDiv = document.getElementById('csvStatus');
                const downloadBtn = document.getElementById('downloadCsvBtn');
                
                statusDiv.innerHTML = '<span class="text-muted"><i class="bi bi-arrow-clockwise spinning"></i> Checking status...</span>';
                
                fetch(window.adminUrls.csvStatus)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            statusDiv.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> Error: ${data.error}</span>`;
                            return;
                        }
                        
                        let statusHtml = '';
                        if (data.file_exists) {
                            statusHtml = `
                                <div class="text-success mb-1">
                                    <i class="bi bi-check-circle"></i> CSV file exists
                                </div>
                                <small class="text-muted">
                                    <strong>Active Users:</strong> ${data.active_users} / ${data.total_users} total<br>
                                    <strong>Last Modified:</strong> ${data.last_modified || 'Unknown'}
                                </small>
                            `;
                            downloadBtn.classList.remove('disabled');
                        } else {
                            statusHtml = `
                                <div class="text-warning">
                                    <i class="bi bi-exclamation-triangle"></i> No CSV file found
                                </div>
                                <small class="text-muted">Upload a CSV file to enable registration control</small>
                            `;
                            downloadBtn.classList.add('disabled');
                        }
                        statusDiv.innerHTML = statusHtml;
                    })
                    .catch(error => {
                        console.error('Error checking CSV status:', error);
                        statusDiv.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> Failed to check status</span>';
                    });
            }
            
            // Add spinning animation for refresh button
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                .spinning {
                    animation: spin 1s linear infinite;
                }
            `;
            document.head.appendChild(style);
        </script>
        
        <!-- External JavaScript file -->
        <script src="{{ url_for('static', filename='js/admin_scripts.js') }}"></script>
        <script>
            // Only keep page-specific JavaScript here if needed
            document.addEventListener('DOMContentLoaded', function() {
                // Load CSV status when page loads
                refreshCsvStatus();
                
                // Add event listener for CSV upload form
                const csvUploadForm = document.getElementById('csvUploadForm');
                if (csvUploadForm) {
                    csvUploadForm.addEventListener('submit', function(e) {
                        const fileInput = document.getElementById('csvFileInput');
                        if (!fileInput.files.length) {
                            e.preventDefault();
                            alert('Please select a CSV file to upload.');
                            return;
                        }
                        
                        const submitBtn = csvUploadForm.querySelector('button[type="submit"]');
                        submitBtn.innerHTML = '<i class="bi bi-arrow-clockwise spinning"></i> Uploading...';
                        submitBtn.disabled = true;
                    });
                }
                
                // Any remaining page-specific JS can stay here
            });
        </script>
</body>
</html> 
