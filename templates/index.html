<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>{{ program_display_name }} Chatbot</title>
  
  <!-- Custom Favicon for Chatbot Admin -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='grad1' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%2322c55e;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%2334d399;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='6' fill='url(%23grad1)'/%3E%3C!-- Robot Head --%3E%3Crect x='8' y='6' width='16' height='12' rx='2' fill='white'/%3E%3C!-- Eyes --%3E%3Ccircle cx='12' cy='11' r='1.5' fill='%2316a34a'/%3E%3Ccircle cx='20' cy='11' r='1.5' fill='%2316a34a'/%3E%3C!-- Mouth --%3E%3Crect x='13' y='14' width='6' height='1' rx='0.5' fill='%2316a34a'/%3E%3C!-- Gear Icon (Admin) --%3E%3Cg transform='translate(20,20) scale(0.8)'%3E%3Cpath d='M6 2L6 0L10 0L10 2L12 2.5L13.5 1L15.5 3L14 4.5L14.5 6L16 6L16 10L14.5 10L14 11.5L15.5 13L13.5 15L12 13.5L10 14L10 16L6 16L6 14L4 13.5L2.5 15L0.5 13L2 11.5L1.5 10L0 10L0 6L1.5 6L2 4.5L0.5 3L2.5 1L4 2.5L6 2Z M8 6A2 2 0 0 0 8 10A2 2 0 0 0 8 6Z' fill='white'/%3E%3C/g%3E%3C/svg%3E">
  <link rel="shortcut icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='grad1' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%2322c55e;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%2334d399;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='6' fill='url(%23grad1)'/%3E%3C!-- Robot Head --%3E%3Crect x='8' y='6' width='16' height='12' rx='2' fill='white'/%3E%3C!-- Eyes --%3E%3Ccircle cx='12' cy='11' r='1.5' fill='%2316a34a'/%3E%3Ccircle cx='20' cy='11' r='1.5' fill='%2316a34a'/%3E%3C!-- Mouth --%3E%3Crect x='13' y='14' width='6' height='1' rx='0.5' fill='%2316a34a'/%3E%3C!-- Gear Icon (Admin) --%3E%3Cg transform='translate(20,20) scale(0.8)'%3E%3Cpath d='M6 2L6 0L10 0L10 2L12 2.5L13.5 1L15.5 3L14 4.5L14.5 6L16 6L16 10L14.5 10L14 11.5L15.5 13L13.5 15L12 13.5L10 14L10 16L6 16L6 14L4 13.5L2.5 15L0.5 13L2 11.5L1.5 10L0 10L0 6L1.5 6L2 4.5L0.5 3L2.5 1L4 2.5L6 2Z M8 6A2 2 0 0 0 8 10A2 2 0 0 0 8 6Z' fill='white'/%3E%3C/g%3E%3C/svg%3E">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <!-- Include marked.js for Markdown formatting (non-optional) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Include DOMPurify for sanitizing HTML -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
  <style>
    .program-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: #f8f8f8;
      border-bottom: 1px solid #ddd;
      margin-bottom: 10px;
    }
    
    .program-title {
      font-size: 18px;
      font-weight: bold;
      color: #0073b1;
    }
    
    .program-badge {
      margin-left: 10px;
      background-color: #0073b1;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: normal;
    }
    
    .switch-program-btn {
      background-color: #0073b1;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .switch-program-btn:hover {
      background-color: #005f87;
    }

    .mic-btn {
      background: #fff;
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: box-shadow 0.2s, background 0.2s;
      margin-right: 8px;
      cursor: pointer;
      outline: none;
      position: relative;
    }
    .mic-btn.active {
      background: #ff4d4f;
      box-shadow: 0 0 0 6px rgba(255,77,79,0.15);
    }
    .mic-btn svg {
      width: 28px;
      height: 28px;
      display: block;
    }
    .mic-btn .mic-wave {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(255,77,79,0.12);
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 0;
    }
    .mic-btn.active .mic-wave {
      opacity: 1;
      animation: mic-wave-pulse 1.2s infinite;
    }
    @keyframes mic-wave-pulse {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
      70% { transform: translate(-50%, -50%) scale(1.4); opacity: 0.2; }
      100% { transform: translate(-50%, -50%) scale(1.7); opacity: 0; }
    }

    .questions-remaining-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #64748b;
      margin-top: 4px;
      font-weight: 500;
      opacity: 0.8;
    }

    .questions-remaining-indicator svg {
      color: #10b981;
      flex-shrink: 0;
    }

    .questions-remaining-indicator.warning {
      color: #f59e0b;
    }

    .questions-remaining-indicator.warning svg {
      color: #f59e0b;
    }

    .questions-remaining-indicator.danger {
      color: #ef4444;
    }

    .questions-remaining-indicator.danger svg {
      color: #ef4444;
    }

    /* Small deletion notice styles */
    .deletion-notice {
      font-size: 10px;
      color: #64748b;
      margin-top: 4px;
      opacity: 0.7;
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .deletion-notice.warning {
      color: #f59e0b;
    }

    .deletion-notice.urgent {
      color: #ef4444;
    }

    .deletion-notice svg {
      width: 12px;
      height: 12px;
      flex-shrink: 0;
    }

    /* Bot message deletion notices */
    .message.bot .deletion-notice {
      position: absolute;
      bottom: -18px;
      left: 8px;
      margin-top: 0;
      font-style: normal;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.05), rgba(0, 0, 0, 0.02));
      backdrop-filter: blur(10px);
      color: rgba(0, 0, 0, 0.6);
      padding: 2px 6px;
      border-radius: 8px;
      font-weight: 400;
      font-size: 8px;
      opacity: 1;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
      letter-spacing: 0.2px;
      text-transform: uppercase;
      transition: all 0.2s ease;
      white-space: nowrap;
      z-index: 10;
    }

    .message.bot {
      position: relative;
      margin-bottom: 25px;
    }

    .message.bot .deletion-notice:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .message.bot .deletion-notice.warning {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.12), rgba(251, 191, 36, 0.06));
      color: rgba(180, 83, 9, 0.8);
      border: 1px solid rgba(251, 191, 36, 0.2);
    }

    .message.bot .deletion-notice.urgent {
      background: linear-gradient(135deg, rgba(248, 113, 113, 0.12), rgba(248, 113, 113, 0.06));
      color: rgba(153, 27, 27, 0.8);
      border: 1px solid rgba(248, 113, 113, 0.2);
    }

    .message.bot .deletion-notice svg {
      width: 8px;
      height: 8px;
      opacity: 0.7;
    }

    /* User message deletion notices - modern & sleek */
    .message.user .deletion-notice {
      position: absolute;
      bottom: -18px;
      right: 8px;
      margin-top: 0;
      font-style: normal;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.05), rgba(0, 0, 0, 0.02));
      backdrop-filter: blur(10px);
      color: rgba(0, 0, 0, 0.6);
      padding: 2px 6px;
      border-radius: 8px;
      font-weight: 400;
      font-size: 8px;
      opacity: 1;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
      letter-spacing: 0.2px;
      text-transform: uppercase;
      transition: all 0.2s ease;
      white-space: nowrap;
      z-index: 10;
    }

    .message.user {
      position: relative;
      margin-bottom: 25px;
    }

    .message.user .deletion-notice:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .message.user .deletion-notice.warning {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.12), rgba(251, 191, 36, 0.06));
      color: rgba(180, 83, 9, 0.8);
      border: 1px solid rgba(251, 191, 36, 0.2);
    }

    .message.user .deletion-notice.urgent {
      background: linear-gradient(135deg, rgba(248, 113, 113, 0.12), rgba(248, 113, 113, 0.06));
      color: rgba(153, 27, 27, 0.8);
      border: 1px solid rgba(248, 113, 113, 0.2);
    }

    .message.user .deletion-notice svg {
      width: 8px;
      height: 8px;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
          <div style="padding: 10px; margin-bottom: 10px; border-radius: 5px; text-align: center; max-width: 800px; margin-left:auto; margin-right:auto; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 100;">
          {% for category, message in messages %}
              <div class="alert alert-{{ category if category else 'info' }}" style="background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; padding: .75rem 1.25rem; margin-bottom: 5px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">{{ message }}</div>
          {% endfor %}
          </div>
      {% endif %}
  {% endwith %}

  <div class="chat-container">
    <div class="modern-header">
      <div class="title-line">
        <h1 class="program-main-title">{{ program_display_name }} Chatbot</h1>
        <div class="questions-remaining-indicator" id="questionsRemaining">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="currentColor"/>
          </svg>
          <span id="remainingCount">{{ remaining_questions }}</span> questions remaining today
        </div>
      </div>
      <div class="user-info-and-actions">
        {% if current_user and current_user.is_authenticated %}
        <div class="user-status-modern">
          Logged in as: <strong>{{ current_user.email }}</strong>
          <span>|</span>
          <a href="{{ url_for('logout') }}" class="logout-link-modern">Logout</a>
        </div>
        {% endif %}
        <div class="header-actions-modern">
          <a href="{{ url_for('switch_program') }}" class="header-button-modern switch-program-modern">Switch Program</a>
          <button id="clear-history-btn" class="header-button-modern danger-modern">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16">
              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
            Delete Conversation
          </button>
        </div>
      </div>
    </div>
    <div id="chat-box" class="chat-box">
      {% if deletion_warning %}
      <div class="message bot deletion-warning-message" style="background-color: #fff3cd; border-left: 4px solid #ffc107; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #f59e0b;">
            <path d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <strong style="color: #92400e;">Privacy Notice</strong>
        </div>
        <p style="margin: 0; color: #92400e;">
          <strong>{{ deletion_warning.count }}</strong> of your {{ deletion_warning.chatbot_name }} conversations will be automatically deleted on 
          <strong>{{ deletion_warning.deletion_date }}</strong> ({{ deletion_warning.days_remaining }} days from now) as part of our privacy protection policy.
        </p>
      </div>
      {% endif %}
      <div class="message bot system-welcome-message">
        <p id="intro-message" data-content='{{ intro_message|tojson|safe }}'></p>
      </div>
      {# Placeholder for chat history messages - will be populated by JS #}
      {% if chat_history %}
        {% for chat in chat_history %}
          <div class="message {{ chat.sender }}" 
               data-sender="{{ chat.sender }}" 
               data-raw='{{ chat.message|tojson|safe }}'
               {% if chat.deletion_info %}data-deletion-info='{{ chat.deletion_info|tojson|safe }}'{% endif %}></div>
        {% endfor %}
      {% endif %}
    </div>
    <div class="input-area-container">
        <div class="attachment-bar" id="attachmentBar">
            <button class="attach-btn" aria-label="Attach file"><i class="bi bi-paperclip"></i></button>
            <button class="attach-btn" aria-label="Use camera"><i class="bi bi-camera"></i></button>
            <button class="attach-btn" aria-label="Record audio"><i class="bi bi-mic-fill"></i></button>
        </div>
        <div class="input-container" id="inputContainer">
          <button class="toggle-attach-bar-btn" id="toggleAttachBarBtn" aria-label="Toggle attachments">
              <i class="bi bi-plus-circle-fill"></i>
          </button>
          <textarea id="userInput" placeholder="Type your message..." rows="1"></textarea>
          <button id="micBtn" class="mic-btn" type="button" aria-label="Start voice input">
            <span class="mic-wave"></span>
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M12 14c1.66 0 3-1.34 3-3V5a3 3 0 0 0-6 0v6c0 1.66 1.34 3 3 3zm-1-9a1 1 0 0 1 2 0v6a1 1 0 0 1-2 0V5z" fill="currentColor"/>
              <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" fill="currentColor"/>
            </svg>
          </button>
          <button id="sendBtn" class="send-btn" aria-label="Send message">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </div>
    </div>
  </div>

  <script>
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('userInput');
    const inputContainer = document.getElementById('inputContainer');
    const attachmentBar = document.getElementById('attachmentBar');
    const toggleAttachBarBtn = document.getElementById('toggleAttachBarBtn');
    let isAttachmentBarVisible = false;

    function scrollToBottom() {
        // A short delay can sometimes help ensure the layout has settled
        setTimeout(() => {
            chatBox.scrollTop = chatBox.scrollHeight;
        }, 50);
    }

    // Auto-resize the textarea as the user types.
    userInput.addEventListener('input', function() {
      recognitionBase = this.value; // Sync base with current input on user edit
      recognitionFinal = ""; // Reset accumulated transcript on manual edit
      this.style.height = 'auto';
      this.style.height = this.scrollHeight + 'px';
      scrollToBottom();
    });

    userInput.addEventListener('focus', function() {
      setTimeout(() => {
        userInput.scrollIntoView({ behavior: 'smooth', block: 'end' });
      }, 300);
    });

    toggleAttachBarBtn.addEventListener('click', () => {
        isAttachmentBarVisible = !isAttachmentBarVisible;
        if (isAttachmentBarVisible) {
            attachmentBar.style.display = 'flex';
            toggleAttachBarBtn.innerHTML = '<i class="bi bi-x-circle-fill"></i>'; // Change to close icon
            userInput.blur(); // Unfocus textarea
        } else {
            attachmentBar.style.display = 'none';
            toggleAttachBarBtn.innerHTML = '<i class="bi bi-plus-circle-fill"></i>'; // Change back to plus icon
        }
        scrollToBottom(); // Ensure chat is visible
    });

    // Allow sending the message when pressing Enter (unless Shift+Enter is used)
    userInput.addEventListener("keydown", function(event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });

    document.getElementById('sendBtn').addEventListener('click', sendMessage);

    function typeMessage(element, text, speed = 10) {
      return new Promise((resolve) => {
        let i = 0;
        element.classList.add('typing');
        function type() {
          if (i < text.length) {
            element.textContent += text.charAt(i);
            i++;
            setTimeout(type, speed);
            scrollToBottom(); // Scroll as message types
          } else {
            element.classList.remove('typing');
            
            // After typing is complete, process any Markdown
            if (typeof marked !== 'undefined') {
                // Store the raw text before parsing
                const rawText = element.textContent;
                // Parse the Markdown and apply it
                const parsedContent = marked.parse(rawText);
                element.innerHTML = typeof DOMPurify !== 'undefined' ? 
                                  DOMPurify.sanitize(parsedContent) : 
                                  parsedContent;
            }
            
            resolve();
          }
        }
        element.textContent = '';
        type();
      });
    }

    function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing-indicator';
      typingDiv.id = 'typing-indicator';
      typingDiv.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
      chatBox.appendChild(typingDiv);
      scrollToBottom();
      return typingDiv;
    }

    function removeTypingIndicator() {
      const typingIndicator = document.getElementById('typing-indicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    function addMessage(text, sender, isHTML = true, deletionInfo = null) {
        const messageDiv = document.createElement('div');
        // 여러 클래스 지원: sender가 공백 포함 문자열이면 분리해서 각각 class로 추가
        if (Array.isArray(sender)) {
            messageDiv.classList.add('message');
            sender.forEach(cls => messageDiv.classList.add(cls));
        } else if (typeof sender === 'string' && sender.includes(' ')) {
            messageDiv.classList.add('message');
            sender.split(' ').forEach(cls => messageDiv.classList.add(cls));
        } else {
            messageDiv.classList.add('message', sender);
        }
        const p = document.createElement('p');
        if (isHTML) {
            if (typeof marked !== 'undefined') {
                const parsedContent = marked.parse(text);
                p.innerHTML = typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(parsedContent) : parsedContent;
            } else {
                p.textContent = text;
            }
        } else {
            p.textContent = text;
        }
        messageDiv.appendChild(p);
        
        // Add deletion notice if provided
        if (deletionInfo) {
            const deletionNotice = createDeletionNotice(deletionInfo);
            if (deletionNotice) {
                messageDiv.appendChild(deletionNotice);
            }
        }
        
        chatBox.appendChild(messageDiv);
        scrollToBottom();
        return p; // Return the paragraph element for typing animation
    }

    function createDeletionNotice(deletionInfo) {
        if (!deletionInfo || deletionInfo.days_until_deletion < 0) {
            return null; // Message already deleted or no auto-delete
        }
        
        const noticeDiv = document.createElement('div');
        noticeDiv.className = 'deletion-notice';
        
        const daysUntil = deletionInfo.days_until_deletion;
        let noticeText, iconSvg, extraClass;
        
        if (daysUntil <= 1) {
            noticeText = daysUntil === 0 ? 'Deletes today' : 'Deletes tomorrow';
            extraClass = 'urgent';
            iconSvg = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>';
        } else if (daysUntil <= 7) {
            noticeText = `Deletes in ${daysUntil} days`;
            extraClass = 'warning';
            iconSvg = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>';
        } else {
            noticeText = `Deletes in ${daysUntil} days`;
            iconSvg = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>';
        }
        
        if (extraClass) {
            noticeDiv.classList.add(extraClass);
        }
        
        noticeDiv.innerHTML = iconSvg + '<span>' + noticeText + '</span>';
        return noticeDiv;
    }

    function updateRemainingQuestions(remaining, quota) {
        const remainingCountElement = document.getElementById('remainingCount');
        const indicatorElement = document.getElementById('questionsRemaining');
        const svgElement = indicatorElement.querySelector('svg');
        
        if (remainingCountElement) {
            remainingCountElement.textContent = remaining;
        }
        
        if (indicatorElement && svgElement) {
            // Remove existing classes
            indicatorElement.classList.remove('warning', 'danger');
            
            // Update icon and color based on remaining count
            if (remaining === 0) {
                indicatorElement.classList.add('danger');
                // X icon for 0 remaining - clearer X mark
                svgElement.innerHTML = '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z" fill="currentColor"/>';
            } else if (remaining === 1) {
                indicatorElement.classList.add('warning');
                // Warning icon for 1 remaining
                svgElement.innerHTML = '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="currentColor"/>';
            } else {
                // Check icon for 2+ remaining (default/good state)
                svgElement.innerHTML = '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="currentColor"/>';
            }
        }
    }

    function sendMessage() {
      const message = userInput.value;
      if (message.trim() === '') return;
      addMessage(message, 'user');
      userInput.value = '';
      userInput.style.height = 'auto';
      const typingIndicator = showTypingIndicator();
      fetch('/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message }),
      })
      .then(response => response.json())
      .then(data => {
        setTimeout(() => {
          removeTypingIndicator();
          const botMessageP = addMessage("", 'bot', true); // Add as HTML, initially empty
          typeMessage(botMessageP, data.reply || "Sorry, I couldn't process that.").then(() => {
              scrollToBottom(); // Final scroll after typing is complete
          });
          
          // Update remaining questions count
          if (data.remaining_questions !== undefined) {
              updateRemainingQuestions(data.remaining_questions, data.quota);
          }
        }, 500); // Delay for bot "thinking"
      })
      .catch(error => {
        console.error('Error:', error);
        removeTypingIndicator();
        addMessage('Error: Could not connect to the server.', 'bot');
      });
    }
    
    // Initial scroll to bottom and rendering of existing messages
    document.addEventListener('DOMContentLoaded', () => {
        // Process intro message with Markdown
        const introMessageElement = document.getElementById('intro-message');
        const introContent = introMessageElement.getAttribute('data-content');
        if (typeof marked !== 'undefined') {
            introMessageElement.innerHTML = DOMPurify.sanitize(marked.parse(introContent));
        } else {
            introMessageElement.textContent = introContent;
        }

        // Process existing messages on page load
        const existingMessages = document.querySelectorAll('.message[data-raw]');
        existingMessages.forEach(messageDiv => {
            const rawData = messageDiv.getAttribute('data-raw');
            const deletionData = messageDiv.getAttribute('data-deletion-info');
            
            if (rawData) {
                try {
                    const messageText = JSON.parse(rawData);
                    const p = messageDiv.querySelector('p') || document.createElement('p');
                    
                    if (typeof marked !== 'undefined') {
                        const parsedContent = marked.parse(messageText);
                        p.innerHTML = typeof DOMPurify !== 'undefined' ? 
                                      DOMPurify.sanitize(parsedContent) : 
                                      parsedContent;
                    } else {
                        p.textContent = messageText;
                    }
                    
                    if (!messageDiv.querySelector('p')) {
                        messageDiv.appendChild(p);
                    }
                } catch (e) {
                    console.error('Error parsing message data:', e);
                }
            }
            
            // Add deletion notice if available
            if (deletionData && !messageDiv.querySelector('.deletion-notice')) {
                try {
                    const deletionInfo = JSON.parse(deletionData);
                    const deletionNotice = createDeletionNotice(deletionInfo);
                    if (deletionNotice) {
                        messageDiv.appendChild(deletionNotice);
                    }
                } catch (e) {
                    console.error('Error parsing deletion data:', e);
                }
            }
        });
        
        // Set initial state for questions remaining indicator
        const initialRemaining = parseInt('{{ remaining_questions }}');
        const initialQuota = parseInt('{{ quota }}');
        updateRemainingQuestions(initialRemaining, initialQuota);
        
        scrollToBottom();
    });

    // Handle potential viewport changes when virtual keyboard shows/hides on mobile
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
            // This gives the height of the visual viewport (excluding keyboard)
            // We can adjust the chatBox height or scroll based on this.
            // For example, ensure the input is visible:
            inputContainer.scrollIntoView({ behavior: 'smooth', block: 'end' });
            scrollToBottom();
        });
    }

    // Clear history button
    document.getElementById('clear-history-btn').addEventListener('click', function() {
        if (confirm("Are you sure you want to delete this conversation history? This action cannot be undone.")) {
            fetch("{{ url_for('clear_chat_history') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ program: '{{ program }}'}) // Send current program
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    chatBox.innerHTML = ''; // Clear visually
                    // Re-add welcome message with Markdown processing
                    const welcomeMessage = '{{ intro_message|safe }}';
                    addMessage(welcomeMessage, 'bot system-welcome-message', true);
                    alert("Conversation history cleared.");
                } else {
                    alert("Error clearing history: " + data.error);
                }
            })
            .catch(error => {
                console.error('Error clearing history:', error);
                alert("Error clearing history.");
            });
        }
    });

    // Speech Recognition setup
    const micBtn = document.getElementById("micBtn");
    let recognition = null;
    let isListening = false;
    let recognitionBase = ""; // The input value when speech recognition starts
    let recognitionFinal = ""; // Accumulated final transcript

    function replaceSpokenPunctuation(text) {
      return text
        .replace(/\s*\bperiod\b\s*/gi, ". ")
        .replace(/\s*\bcomma\b\s*/gi, ", ")
        .replace(/\s*\bexclamation (point|mark)\b\s*/gi, "! ")
        .replace(/\s*\bquestion mark\b\s*/gi, "? ")
        .replace(/\s*\bcolon\b\s*/gi, ": ")
        .replace(/\s*\bsemicolon\b\s*/gi, "; ")
        .replace(/\s*\bdash\b\s*/gi, "-")
        .replace(/\s*\bopen parenthesis\b\s*/gi, " (")
        .replace(/\s*\bclose parenthesis\b\s*/gi, ") ");
    }

    function autoCapitalizeSentences(text) {
      // Capitalize the first letter of the text and after punctuation
      return text.replace(/(^\s*\w|[.!?]\s*\w)/g, function(match) {
        return match.toUpperCase();
      });
    }

    // Check if browser supports Speech Recognition
    if ("webkitSpeechRecognition" in window || "SpeechRecognition" in window) {
        // Initialize speech recognition
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = true;  // Changed to true to keep recording
        recognition.interimResults = true;
        recognition.lang = "en-US"; // Set language (English)

        // Handle results
        recognition.onresult = function(event) {
            let interimTranscript = "";
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    recognitionFinal += event.results[i][0].transcript;
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }
            // Process transcripts
            let finalText = autoCapitalizeSentences(replaceSpokenPunctuation(recognitionFinal));
            let interimText = autoCapitalizeSentences(replaceSpokenPunctuation(interimTranscript));
            userInput.value = recognitionBase + finalText + interimText;
            userInput.style.height = "auto";
            userInput.style.height = userInput.scrollHeight + "px";
        };

        // Handle end of speech recognition
        recognition.onend = function() {
            // Only save transcript if we're actually stopping (not just pausing)
            if (!isListening) {
                if (userInput.value) {
                    recognitionFinal = userInput.value;
                }
                micBtn.classList.remove("active");
            } else {
                // If we're still supposed to be listening, restart recognition
                try {
                    recognition.start();
                } catch (error) {
                    console.error("Error restarting recognition:", error);
                }
            }
        };

        // Handle errors
        recognition.onerror = function(event) {
            console.error("Speech recognition error:", event.error);
            isListening = false;
            micBtn.classList.remove("active");
            if (event.error === "not-allowed") {
                alert("Microphone access is required. Please allow microphone access in your browser settings.");
            }
        };

        // Toggle speech recognition on button click
        micBtn.addEventListener("click", function() {
            if (isListening) {
                recognition.stop();
                isListening = false;
                micBtn.classList.remove("active");
            } else {
                try {
                    recognitionBase = userInput.value; // Save input value at recognition start
                    recognitionFinal = "";
                    recognition.start();
                    isListening = true;
                    micBtn.classList.add("active");
                    userInput.focus();
                } catch (error) {
                    console.error("Speech recognition error:", error);
                    alert("Could not start speech recognition. Please check your browser settings.");
                }
            }
        });
        
        // Track last click time for double-click detection
        let lastClickTime = 0;
    } else {
        // Browser does not support speech recognition
        micBtn.addEventListener("click", function() {
            alert("This browser does not support speech recognition. Please use Chrome or Edge browser.");
        });
        console.warn("Speech Recognition not supported in this browser");
    }
  </script>
</body>
</html>
